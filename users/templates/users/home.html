{% extends 'users/base.html' %}
{% load static %}

{% block body %}
<div class="my-10 mx-3 flex items-center">
  <!-- Input Box -->
  <input
      class="border w-96 h-12 px-4 rounded-l-lg shadow-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
      type="text"
      placeholder="Add friends through mail id...." oninput="searchFriends()" id="search-friends">

  <!-- Clear Button -->
  <button
      class="bg-gray-200 px-4 h-12 rounded-r-lg hover:bg-gray-300 text-gray-700 font-medium"
      onclick="this.previousElementSibling.value = ''">
      Clear
  </button>
</div>


<div class="flex justify-between items-center p-4">
    <div id="list-friends"></div>

    <div class="relative">
        <!-- Bell icon -->
        <button id="bell" class="relative">
            <img src="{% static 'users/images/bell.png' %}" alt="" class="w-13 h-10">
        </button>

        <!-- Notifications dropdown -->
        <div id="notification" class="hidden absolute right-0 mt-2 w-64 bg-white border rounded-lg shadow-lg max-h-80 overflow-y-auto z-50">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
</div>

  

<div class="flex justify-center mt-10 space-x-6">

  <!-- Left Card: Friends List -->
  <div class="w-1/3 bg-white shadow-lg rounded-2xl p-5">
    <h2 class="text-xl font-bold mb-4 text-purple-500">Your Friends</h2>
    <div class="space-y-4">
      {% for friend in friends %}
        <div class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100" onclick="openChat('{{ friend.id }}','{{ friend.name }}')">
          <img src="{{ friend.icon }}" alt="{{ friend.name }} profile_pic"
               class="w-12 h-12 rounded-full border">
          <span class="text-lg font-medium">{{ friend.name }}</span>
        </div>
      {% empty %}
        <p class="text-gray-500">No friends yet.</p>
      {% endfor %}
    </div>
  </div>


<!-- Right Chat Card -->
    <div id="chat-box" class="w-2/3 bg-white shadow-lg rounded-2xl p-5">
      <h2 id="chat-title" class="text-xl font-bold mb-4 text-gray-800">
        Select a friend to start chatting
      </h2>

      <!-- Chat Messages -->
      <div id="messages" class="h-80 overflow-y-auto border rounded-lg p-3 bg-gray-50">
        <p class="text-gray-400">No chat selected.</p>
      </div>

      <!-- Input Box (only visible after selecting a friend) -->
      <form id="chat-form" class="mt-3 flex hidden">
        <input id="chat-message-input" type="text" placeholder="Type a message..."
               class="flex-1 border rounded-l-lg p-2 focus:outline-none">
        <button id="chat-message-submit" type="submit"
                class="bg-blue-500 text-white px-4 rounded-r-lg">Send</button>
      </form>
    </div>


</div>

<script>
    let chatSocket = null;
    let selectedFriendId = null;
    let sender_id  = '{{ user_obj.id }}';
    let searchSocket = null;

    const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    let notificationSocket = new WebSocket(protocol + window.location.host + `/ws/notifications/${sender_id}/`);
    console.log(notificationSocket)

    notificationSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log("Notification:", data);

            if (data.type === "notification") {
                renderNotifications(data.message);
            }
        };

        // Render notifications into dropdown
        function renderNotifications(notifications) {
            const container = document.getElementById("notification");
            container.innerHTML = ""; // Clear old notifications

            notifications.forEach(item => {
                const div = document.createElement("div");
                div.classList.add("flex", "items-center", "p-2", "hover:bg-gray-100", "cursor-pointer");

                div.innerHTML = `
                    <div id='${item.user_id}'>
                        <img src="${item.icon}" alt="icon" class="w-8 h-8 rounded-full mr-2">
                        <div class="flex flex-col">
                            <span class="font-medium">${item.sender}</span>
                            <span class="text-xs text-gray-500">${new Date(item.created_at).toLocaleString()}</span>
                            <div class="flex space-x-2">
                                <button class="accept-btn bg-green-500 text-white px-2 py-1 rounded text-sm" data-id="${item.user_id}" onclick="accept_reject('${item.user_id}',true)" >Accept</button>
                                <button class="reject-btn bg-red-500 text-white px-2 py-1 rounded text-sm" data-id="${item.user_id}" onclick="accept_reject('${item.user_id}',false)" >Reject</button>
                            </div>
                            
                        </div>
                    </div>
                `;

                container.appendChild(div);
            });
        }

        // Toggle dropdown when clicking bell
        document.getElementById("bell").addEventListener("click", () => {
            const box = document.getElementById("notification");
            box.classList.toggle("hidden");
        });

    function accept_reject(friend_id,checker){
        checker = checker.toString();
        let accept_reject_socket  = new WebSocket(protocol + window.location.host + `/ws/accept-reject/${friend_id}/${sender_id}/${checker}/`); 

        document.getElementById(friend_id).remove()

        accept_reject_socket.onmessage = function(e){
            data = JSON.parse(e.data);
            window.location.href = data.redirect_url;
            accept_reject_socket.close();
        }

   
    }
    function sendRequest(friend_id) {

        const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";

        const addfriendSocket = new WebSocket(protocol + window.location.host + `/ws/add-friend/${sender_id}/${friend_id}/`);

        addfriendSocket.onmessage = function(e){

            const data = JSON.parse(e.data);

            

            window.alert(data.message)
            addfriendSocket.close();
            

        }
        }
    function searchFriends() {
        const searchBox = document.getElementById("search-friends");
        const searchValue = searchBox.value.trim();

        if (!searchSocket || searchSocket.readyState === WebSocket.CLOSED) {
            const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
            searchSocket = new WebSocket(protocol + window.location.host + `/ws/search-friends/${sender_id}/`);

            // Send search when connection opens
            searchSocket.onopen = function() {
                if (searchValue !== "") {
                    searchSocket.send(JSON.stringify({ search: searchValue }));
                }
                else{
                    document.getElementById("list-friends").innerHTML = "";
                }
            };

            searchSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log("Received data:", data);  // Add this
                const listContainer = document.getElementById("list-friends");
                listContainer.innerHTML = ""; // Clear previous results

                if (data.friends && data.friends.length > 0) {
                    data.friends.forEach(friend => {
                        const friendDiv = document.createElement("div");
                        friendDiv.className = "flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 cursor-pointer";
                        // friendDiv.onclick = () => openChat(friend.id, friend.name);

                        if(friend.is_friend){

                            friendDiv.innerHTML = `
                            <img src="${friend.icon}" alt="${friend.name}" class="w-10 h-10 rounded-full border">
                            <span class="text-lg font-medium">${friend.name}</span> <span class="px-3 py-1 bg-green-100 text-green-700 text-sm font-medium rounded-full">Already Connected</span>
`;

                        }

                        else{
                        friendDiv.innerHTML = `
                            <img src="${friend.icon}" alt="${friend.name}" class="w-10 h-10 rounded-full border">
                            <span class="text-lg font-medium">${friend.name}</span> 
                            <button class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-full" onclick='sendRequest(${friend.user_id})' >Add Friend</button>
                        `;
                        }
                        listContainer.appendChild(friendDiv);
                        
                    });
                } else {
                    listContainer.innerHTML = "<p class='text-gray-500'>No friends found.</p>";
                }
            };



            searchSocket.onclose = function(e) {
                console.error("Search socket closed unexpectedly", e);
            };

            searchSocket.onerror = function(e) {
                console.error("Search socket error:", e);
            };
        } else {
            // If socket is already open, just send the query
            if (searchValue !== "") {
                searchSocket.send(JSON.stringify({ search: searchValue }));
            }
            else{
                    document.getElementById("list-friends").innerHTML = "";
                }4
        }
    }



    function formatDateTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString("en-IN", {
            day: "2-digit",
            month: "short",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        });
    }

    function openChat(friendId, friendName) {
        selectedFriendId = friendId;
        document.getElementById("chat-title").innerHTML = `Chat with <span class="text-purple-700 font-semibold">${friendName}</span>`;
        document.getElementById("messages").innerHTML = "";
        document.getElementById("chat-form").classList.remove("hidden");

        if (chatSocket) {
            chatSocket.close();
        }

        const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        chatSocket = new WebSocket(protocol + window.location.host + `/ws/chat/${sender_id}/${selectedFriendId}/`);

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const msgBox = document.getElementById("messages");
            const msg = document.createElement("div");

            let timeInfo = "";
            if (data.created_at) {
                timeInfo = `<div class="text-xs text-gray-500 mt-1">${formatDateTime(data.created_at)}</div>`;
            }

            if (data.sender == sender_id) {
                // Current user → right side
                msg.className = "mb-3 flex flex-col items-end";
                msg.innerHTML = `
                    <div class="inline-block px-3 py-2 rounded-lg bg-blue-500 text-white">
                        ${data.message}
                    </div>
                    ${timeInfo}
                `;
            } else {
                // Friend → left side
                msg.className = "mb-3 flex flex-col items-start";
                msg.innerHTML = `
                    <div class="inline-block px-3 py-2 rounded-lg bg-gray-300 text-black">
                        ${data.message}
                    </div>
                    ${timeInfo}
                `;
            }

            msgBox.append(msg);
            msgBox.scrollTop = msgBox.scrollHeight;
        };

        chatSocket.onclose = function(e) {
            console.error("Chat socket closed unexpectedly", e);
        };

        chatSocket.onerror = function(e) {
            console.error("Chat socket error:", e);
        };
    }

    // Attach only once
    document.getElementById("chat-form").onsubmit = function (e) {
        e.preventDefault();
        const input = document.getElementById("chat-message-input");
        if (input.value.trim() !== "" && chatSocket && selectedFriendId) {
            chatSocket.send(JSON.stringify({
                type: 'message',
                sender: sender_id,
                receiver: selectedFriendId,
                message: input.value
            }));
            input.value = "";
        }
    };
</script>


{% endblock %}
